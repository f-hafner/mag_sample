---
title: "Performance of linking researchers to NSF Grants"
author: "Flavio & Christoph & Mona"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  pdf_document:
    toc: true
    toc_depth: 3
---
This script makes some plots of the grant links. The second graph only depicts geology so far.  

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
set.seed(1234)
```

```{r, echo = FALSE, include = FALSE}
packages <- c("tidyverse", "broom", "dbplyr", "RSQLite", "ggplot2", "stringdist")

lapply(packages, library, character.only = TRUE)

datapath <- "/mnt/ssd/"
db_file  <- paste0(datapath, "AcademicGraph/AcademicGraph.sqlite")
select_fields <- c("geology" ) # test


# select_fields <- c("art",
#                    "biology",
#                    "business",
#                    "chemistry",
#                    "computer science" ,
#                    "economics",
#                    "engineering",
#                    "environmental science",
#                    "geography",
#                    "geology" ,
#                    "history",
#                    "materials science",
#                    "mathematics",
#                    #"medicine",
#                    "philosophy",
#                    "physics",
#                    "political science",
#                    "psychology" ,
#                    "sociology") # fields currently matched 

# ## db connection
con <- DBI::dbConnect(RSQLite::SQLite(), db_file)
cat("The database connection is: \n")
src_dbi(con)
```





```{r}
# parameters for selecting links 
min_score_grants <- 0.7 # minimum score from dedupe 

```


## Overview

```{r, include = FALSE}

linking_info <- tbl(con,
                    sql("select iteration_id, field
                          from (
                              select *, max(iteration_id) OVER(partition by field) as max_iter
                              from linking_info_grants
                              where recall = 0.9 
                                  and testing = 0
                                  and institution = 'True'
                                  and fieldofstudy_cat = 'False'
                                  and fieldofstudy_str = 'False' 
                                  and keywords = 'False' 
                                  and mergemode = 'm:1'
                          )
                          where iteration_id = max_iter "))


linked_grants <- tbl(con, sql("select * 
                                 from linked_ids_grants
                                 ")) %>%
   inner_join(linking_info %>% 
                select(iteration_id),
              by = "iteration_id")
 
# 
# # load all grants try code below
grants <- tbl(con, sql("
          SELECT a.GrantID || \"_\" || c.author_position as grantid_authorposition
              , CAST(SUBSTR(a.Award_AwardEffectiveDate, 7, 4) AS INT) AS year 
              ,a.GrantID, b.institution, c.firstname, c.lastname, c.middlename
          FROM NSF_MAIN as a
          INNER JOIN (
              SELECT GrantID, Name AS institution
              FROM NSF_Institution
              WHERE Position = 0  
          ) b
          USING (GrantID)
          INNER JOIN (
              SELECT GrantID
                  , FirstName AS firstname
                  , LastName AS lastname
                  , PIMidInit AS middlename  
                  , Position as author_position  
              FROM NSF_Investigator
              WHERE RoleCode = 'principal investigator'
          ) c
          USING (GrantID)
          WHERE AWARD_TranType = 'grant' AND AWARD_Agency = 'nsf'
              AND a.AwardInstrument_Value IN ('standard grant', 'continuing grant')
              AND c.lastname != 'data not available'
              AND CAST(SUBSTR(a.Award_AwardEffectiveDate, 7, 4) AS INT) >= 1990
              AND CAST(SUBSTR(a.Award_AwardEffectiveDate, 7, 4) AS INT) <= 2020
              AND b.institution != \"travel award\"
                   ")
              )

        # query_nsf = f"""
#    
# Load csv file for geology instead of file from database:
# To do: other fields need to be adjusted 

links_grants_geology_mona_degree0_19902015 <- read.csv("/mnt/ssd/linked_ids_temp/links_grants_geology_mona_degree0_19902015.csv")

```


```{r}
linked_grants_geology <- collect(links_grants_geology_mona_degree0_19902015)
linked_grants <- collect(linked_grants)
grants <- collect(grants)
linking_info <- collect(linking_info)
```


## Linking scores 
- conditioning on link score > 0.7 is fine

```{r}

linked_grants %>%
  left_join(linking_info, by = "iteration_id") %>%
  filter(link_score>=0.7) %>%
  ggplot(aes(x = link_score)) +
  geom_histogram(bins = 100, aes( y = after_stat(density))) +
  facet_wrap(~field)

```

## Link performance by graduation year: so far only for geology

- fraction of grants where the link_score is above the treshold
- the mean link score for grants where dedupe finds a link (link_score is not NA)
- in the figure above, we used the field from iteration_id, but this only works for grants that dedupe suggests to be a link 

```{r}
keep_fields <- select_fields
# c("biology", "chemistry", "computer science", 
#                 "economics", "engineering", "environmental science", 
#                 "geography", "geology", "mathetmatics", "physics",
#                 "political science", "psychology", "sociology")


score_by_year <- grants %>% 
   left_join(linked_grants_geology,
           by = "grantid_authorposition")%>% 
   filter(year >= 1985) #%>%
   #filter(link_score>=0.7) #%>%
   #filter(field %in% keep_fields)


score_by_year %>%
  mutate(link_score_adj = ifelse(is.na(link_score), -1, link_score)) %>%
  group_by(year) %>%
  #p50_score = quantile(link_score, probs = 0.5),
  summarise(mean_score = mean(link_score, na.rm = TRUE),
            share_linked = mean(link_score_adj > min_score_grants),
            .groups = "drop") %>%
  pivot_longer(cols = all_of(c("mean_score", "share_linked")),
               names_to = "stat") %>%
  ggplot(aes(x = year, y = value)) +
  geom_line(aes(linetype = stat)) +
  facet_wrap(~"Geology") +
  theme(legend.position = "bottom")
```



```{r, include = FALSE}
DBI::dbDisconnect(con)
```


Why is the linking score so low? 


 
```{r}

# # Look at examples: Sharon L. Wood, Michael D. Engelhardt, Jonathan Bell
# 
# mag <- tbl(con, 
#            sql("select AuthorId, NormalizedName, DisplayName
#                 from Authors
#                 WHERE NormalizedName LIKE '%sharon%'
#                 AND NormalizedName LIKE '%wood%'
#                 OR NormalizedName LIKE '%michael%'
#                 AND NormalizedName LIKE '%engelhardt%'
#                 OR NormalizedName LIKE '%jonathan%'
#                 AND NormalizedName LIKE '%bell%'
#                "))
# mag <- collect(mag)
# 
# 
# # All persons exist somewhere in mag but were not linked -> even right person?
```


Collect more info about authors that are not linked: 

```{r}
library(RSQLite)

# create a database connection
con <- dbConnect(RSQLite::SQLite(), "/mnt/ssd/AcademicGraph/AcademicGraph.sqlite")

# execute the query and store the results in a data frame
query_mag <- "
SELECT f.AuthorId
        , f.year
        , f.firstname
        , f.lastname
        , CASE TRIM(SUBSTR(f.middle_lastname, 1, f.l_fullname - f.l_firstname - f.l_lastname - 1)) 
            WHEN 
                '' THEN NULL 
                ELSE TRIM(SUBSTR(f.middle_lastname, 1, f.l_fullname - f.l_firstname - f.l_lastname - 1)) 
            END as middlename 
            -- ## NOTE this gives '' for middlename when it is missing 
        , f.fieldofstudy
        , g.keywords
        , g.coauthors
        , g.institution
        , g.year_papertitle
    FROM (
        SELECT a.AuthorId
            , a.YearFirstPub AS year
            , a.FirstName AS firstname
            , REPLACE(b.NormalizedName, RTRIM(b.NormalizedName, REPLACE(b.NormalizedName, ' ', '')), '') AS lastname 
            , TRIM(SUBSTR(b.NormalizedName, length(a.FirstName) + 1)) AS middle_lastname 
            , length(b.NormalizedName) as l_fullname 
            , length(a.FirstName) as l_firstname
            , length(REPLACE(b.NormalizedName, RTRIM(b.NormalizedName, REPLACE(b.NormalizedName, ' ', '')), '')) as l_lastname
            , e.NormalizedName AS fieldofstudy
        FROM author_sample AS a
        INNER JOIN (
            SELECT AuthorId, NormalizedName
            FROM Authors
            WHERE NormalizedName LIKE '%sharon%'    
            AND NormalizedName LIKE '%wood%'
        ) AS b USING(AuthorId)
            LEFT JOIN (
            SELECT AuthorId, NormalizedName
            FROM author_fields c
            INNER JOIN (
                SELECT FieldOfStudyId, NormalizedName
                FROM FieldsOfStudy
            ) AS d USING(FieldOfStudyId)
        ) AS e USING(AuthorId)
    ) f
    LEFT JOIN (
        SELECT AuthorId
                , institutions as institution
                , main_us_institutions_career
                , coauthors
                , keywords
                , year_papertitle
        FROM author_info_linking
    ) AS g USING(AuthorId)
"

df1 <- dbGetQuery(con, query_mag)
#df1: sharon wood
#df2: michael engelhardt
#df3: jonathan bell

# close the database connection
dbDisconnect(con)

```

Examples for persons that were not linked in geology:
Adjust name in line 262f 

df: sharon l. wood (geology)
NSF grants: University of Illinois at Urbana Champaign (1994); University of Texas at Austin (2000-2003)
mag (df): no observation with correct institution-year combination or in correct field 
maybe: 1989 University of Texas at Austin in engineering

df2: michael d. engelhardt (geology)
NFS grants: University of Texas at Austin (1990-2013)
mag (df2): no observation at correct institution or correct field
maybe: 1986 at University of California Berkely in engineering

df3: jonathan bell (geology)
NSF grants: University of Maryland (2000-2004); George Mason (2018-2019, 2020); Northeastern University (2020)
mag (df3): no observation at any university or in correct field




