---
title: "Performance of linking researchers to NSF Grants"
author: "Flavio & Christoph & Mona"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  pdf_document:
    toc: true
    toc_depth: 3
---
This script makes some plots of the grant links. But not all fields complete

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
set.seed(1234)
```

```{r, echo = FALSE, include = FALSE}
packages <- c("tidyverse", "broom", "dbplyr", "RSQLite", "ggplot2", "stringdist")

lapply(packages, library, character.only = TRUE)

datapath <- "/mnt/ssd/"
db_file  <- paste0(datapath, "AcademicGraph/AcademicGraph.sqlite")

# less fields than in advisors, e.g. art, business, history, material sciences, philosophy not included in grant linking -> to do? 

 select_fields <- c("biology",
                    "chemistry",
                    "computer science" ,
                    "economics",
                    "engineering",
                    "environmental science",
                    "geography",
                    "geology" ,
                    "mathematics",
                    "physics",
                    "political science",
                    "psychology" ,
                    "sociology") # fields currently matched 

# ## db connection
con <- DBI::dbConnect(RSQLite::SQLite(), db_file)
cat("The database connection is: \n")
src_dbi(con)
```

```{r}
# parameters for selecting links 
min_score_grants <- 0.7 # minimum score from dedupe 

```


## Overview

```{r, include = FALSE}

linking_info <- tbl(con,
                    sql("select iteration_id, field
                          from (
                              select *, max(iteration_id) OVER(partition by field) as max_iter
                              from linking_info_grants
                              where recall = 0.9 
                                  and testing = 0
                                  and institution = 'True'
                                  and fieldofstudy_cat = 'False'
                                  and fieldofstudy_str = 'False' 
                                  and keywords = 'False' 
                                  and mergemode = 'm:1'
                          )
                          where iteration_id = max_iter "))


linked_grants <- tbl(con, sql("select * 
                                 from linked_ids_grants
                                 ")) %>%
   inner_join(linking_info %>% 
                select(iteration_id),
              by = "iteration_id")
 

# # load all NSF grants

grants <- tbl(con, sql("
          SELECT a.GrantID || \"_\" || c.author_position as grantid_authorposition
              , CAST(SUBSTR(a.Award_AwardEffectiveDate, 7, 4) AS INT) AS year 
              ,a.GrantID, b.institution, c.firstname, c.lastname, c.middlename
          FROM NSF_MAIN as a
          INNER JOIN (
              SELECT GrantID, Name AS institution
              FROM NSF_Institution
              WHERE Position = 0  
          ) b
          USING (GrantID)
          INNER JOIN (
              SELECT GrantID
                  , FirstName AS firstname
                  , LastName AS lastname
                  , PIMidInit AS middlename  
                  , Position as author_position  
              FROM NSF_Investigator
              WHERE RoleCode = 'principal investigator'
          ) c
          USING (GrantID)
          WHERE AWARD_TranType = 'grant' AND AWARD_Agency = 'nsf'
              AND a.AwardInstrument_Value IN ('standard grant', 'continuing grant')
              AND c.lastname != 'data not available'
              AND CAST(SUBSTR(a.Award_AwardEffectiveDate, 7, 4) AS INT) >= 1990
              AND CAST(SUBSTR(a.Award_AwardEffectiveDate, 7, 4) AS INT) <= 2020
              AND b.institution != \"travel award\"
                   ")
              )

        # query_nsf = f"""



```


```{r}
linked_grants <- collect(linked_grants)
grants <- collect(grants)
linking_info <- collect(linking_info)
```


## Linking scores 
- conditioning on link score > 0.7 is fine

```{r}

linked_grants %>%
  left_join(linking_info, by = "iteration_id") %>%
  filter(link_score>=0.7) %>%
  ggplot(aes(x = link_score)) +
  geom_histogram(bins = 100, aes( y = after_stat(density))) +
  facet_wrap(~field)
  
```

## Link performance by graduation year: so far only for geology

- fraction of grants where the link_score is above the treshold
- the mean link score for grants where dedupe finds a link (link_score is not NA)
- in the figure above, we used the field from iteration_id, but this only works for grants that dedupe suggests to be a link 

```{r}
keep_fields <- select_fields
# c("biology", "chemistry", "computer science", 
#                 "economics", "engineering", "environmental science", 
#                 "geography", "geology", "mathetmatics", "physics",
#                 "political science", "psychology", "sociology")


score_by_year <- grants %>% 
   left_join(linked_grants,
           by = "grantid_authorposition")%>% 
   filter(year >= 1980) #%>%
   #filter(link_score>=0.7) #%>%
   filter(field %in% keep_fields)



#New: linked_grants_share is share of linked grants to total number of grants 
# add restriction of only keeping GrantID with highest score if GrantID exists several times?

score_by_year %>%
  mutate(link_score_adj = ifelse(is.na(link_score), -1, link_score)) %>%
  group_by(year) %>%
  #p50_score = quantile(link_score, probs = 0.5),
 summarise(grants_total = n_distinct(GrantID),
            mean_score = mean(link_score, na.rm = TRUE),
            share_linked = mean(link_score_adj > min_score_grants),
            .groups = "drop") %>%
 filter(link_score > min_score_grants) %>%
  summarise(ngrants_linked = n_distinct(GrantID),
             .groups = "drop") %>%
  summarise(linked_grants_share=ngrants_linked/grants_total)
  pivot_longer(cols = all_of(c("linked_grants_share", "mean_score", "share_linked")),
               names_to = "stat") %>%
  ggplot(aes(x = year, y = value)) +
  geom_line(aes(linetype = stat)) +
  facet_wrap(~field) +
  theme(legend.position = "bottom")

# Don't really understand old code below
# Share link is not really the share of linked grants or is it? 
# Why share linked < mean_score if restriction to link_score>0.7?

# score_by_year %>%
#   mutate(link_score_adj = ifelse(is.na(link_score), -1, link_score)) %>%
#   group_by(year) %>%
#   #p50_score = quantile(link_score, probs = 0.5),
#   summarise(mean_score = mean(link_score, na.rm = TRUE),
#             share_linked = mean(link_score_adj > min_score_grants),
#             .groups = "drop") %>%
#   pivot_longer(cols = all_of(c("mean_score", "share_linked")),
#                names_to = "stat") %>%
#   ggplot(aes(x = year, y = value)) +
#   geom_line(aes(linetype = stat)) +
#   facet_wrap(~field) +
#   theme(legend.position = "bottom")
```



```{r, include = FALSE}
DBI::dbDisconnect(con)
```