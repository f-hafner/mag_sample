---
title: "Performance of linking graduates to researchers"
author: "Flavio & Christoph"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  pdf_document:
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
set.seed(1234)


```

```{r, echo = FALSE, include = FALSE}
packages <- c("tidyverse", "broom", "dbplyr", "RSQLite", "ggplot2", "lubridate")

lapply(packages, library, character.only = TRUE)

datapath <- "/mnt/ssd/"
db_file  <- paste0(datapath, "AcademicGraph/AcademicGraph.sqlite")
select_fields <- c("art",
                   "biology",
                   "business",
                   "chemistry",
                   "computer science" ,
                   "economics",
                   "engineering",
                   "environmental science",
                   "geography",
                   "geology" ,
                   "history",
                   "materials science",
                   "mathematics",
                   "medicine",
                   "philosophy",
                   "physics",
                   "political science",
                   "psychology" ,
                   "sociology") # all fields are currently matched



date_method_change <- ymd("2022-07-01") # after summer we extended the sampling period and added more features 

# thresholds for identified links 
min_link_score <- 0.7
max_year_diff <- 10
# Hofstra et al are much more generous here (10 year pre graduation, 15 year post graduation).
  # we may do the same, but we need to consistently label; 
  #also, at the current stage a higher boundary here will lead to more links to the duplicated entities

# ## db connection
con <- DBI::dbConnect(RSQLite::SQLite(), db_file)
cat("The database connection is: \n")
src_dbi(con)
```

## Overview

### SQL example for sourcing number of authors with same name 

```sql 
select * 
from author_sample
inner join (
    select authorid, normalizedname, papercount, citationcount
    from authors 
    where normalizedname = "lawrence b slobodkin"
) using (authorid)
inner join (
    select authorid, fieldofstudyid
    from author_fields 
    where fieldclass = "first"
) using (authorid)
```

```{r, include = FALSE}
field_names_id <- tbl(con, sql(paste0(
    "SELECT FieldOfStudyId, NormalizedName
    FROM FieldsOfStudy
    WHERE Level = 0 
        AND NormalizedName IN (", 
        paste0(paste0("'", select_fields, "'"), collapse = ", "),
        ")"
)))
field_names_id <- collect(field_names_id)

query_proquest <- paste0(
 "SELECT goid
            , year
            , firstname 
            , lastname
            , CASE TRIM(SUBSTR(middle_lastname, 1, l_fullname-l_firstname-l_lastname - 1)) 
                WHEN 
                    '' THEN NULL 
                    ELSE TRIM(SUBSTR(middle_lastname, 1, l_fullname-l_firstname-l_lastname - 1)) 
                END AS middlename
            , fieldofstudy
            , mag_field0
            , university_id
    FROM (
        SELECT goid
            , degree_year AS year 
            , fullname 
            , SUBSTR(TRIM(fullname),1,instr(trim(fullname)||' ',' ')-1) AS firstname
            , REPLACE(fullname, RTRIM(fullname, REPLACE(fullname, ' ', '')), '') AS lastname 
            , TRIM(SUBSTR(fullname, length(SUBSTR(TRIM(fullname),1,instr(trim(fullname)||' ',' ')-1)) + 1)) AS middle_lastname 
            , length(fullname) AS l_fullname 
            , length(SUBSTR(TRIM(fullname),1,instr(trim(fullname)||' ',' ')-1) ) AS l_firstname
            , length(REPLACE(fullname, RTRIM(fullname, REPLACE(fullname, ' ', '')), '')) AS l_lastname
            , fieldname AS fieldofstudy
            , mag_field0
            , university_id
        FROM pq_authors 
        INNER JOIN (
            SELECT goid, fieldname, mag_field0
            FROM pq_fields_mag
            WHERE mag_field0 IN (",
            paste0(field_names_id$FieldOfStudyId, collapse = ', '),
            ") AND position = 0
        ) USING (goid)
        INNER JOIN (
            SELECT university_id
            FROM pq_unis
            WHERE location like '%United States%'
        ) USING(university_id)
)
WHERE year >= 1985 and year <= 2015 AND length(firstname) > 1
")

query_mag <- paste0(
 "SELECT AuthorId
        , year
        , firstname
        , lastname
        , CASE TRIM(SUBSTR(middle_lastname, 1, l_fullname-l_firstname-l_lastname - 1)) 
            WHEN 
                '' THEN NULL 
                ELSE TRIM(SUBSTR(middle_lastname, 1, l_fullname-l_firstname-l_lastname - 1)) 
            END as middlename 
        , fieldofstudy
        , mag_field0 
    FROM (
        SELECT a.AuthorId
            , a.YearFirstPub AS year
            , a.FirstName AS firstname
            , REPLACE(b.NormalizedName, RTRIM(b.NormalizedName, REPLACE(b.NormalizedName, ' ', '')), '') AS lastname 
            , TRIM(SUBSTR(b.NormalizedName, length(a.FirstName) + 1)) AS middle_lastname 
            , length(b.NormalizedName) as l_fullname 
            , length(a.FirstName) as l_firstname
            , length(REPLACE(b.NormalizedName, RTRIM(b.NormalizedName, REPLACE(b.NormalizedName, ' ', '')), '')) as l_lastname
            , e.NormalizedName AS fieldofstudy
            , e.ParentFieldOfStudyId as mag_field0
        FROM author_sample AS A 
        INNER JOIN (
            SELECT AuthorId, NormalizedName
            FROM Authors
        ) AS b USING(AuthorId)
        INNER JOIN (
            SELECT AuthorId, NormalizedName, ParentFieldOfStudyId
            FROM author_fields c
            INNER JOIN (
                SELECT FieldOfStudyId, NormalizedName
                FROM FieldsOfStudy
            ) AS d USING(FieldOfStudyId)
            INNER JOIN (
                SELECT ParentFieldOfStudyId
                    , ChildFieldOfStudyId
                    , ParentFieldOfStudyId 
                FROM crosswalk_fields
                WHERE ParentLevel = 0
                    AND ParentFieldOfStudyId IN (",
                         paste0(field_names_id$FieldOfStudyId, collapse = ", "),
                    ")
            ) AS e ON (e.ChildFieldOfStudyId = c.FieldOfStudyId)
            WHERE FieldClass = 'first'
        ) AS e USING(AuthorId)
    )
WHERE year >= 1980 and year <= 2022 AND length(firstname) > 1
")

```

```{r, include = FALSE}
linked_ids <- tbl(con, "linked_ids") 
linking_info <- tbl(con, "linking_info") %>%
    filter(mergemode == "1:1" & fieldofstudy_str == "False")
pq_authors <- tbl(con, sql(query_proquest))
mag_authors <- tbl(con, sql(query_mag))

```

```{r, include = FALSE}
mag_authors <- collect(mag_authors)
linked_ids <- collect(linked_ids)
linking_info <- collect(linking_info)
pq_authors <- collect(pq_authors)
```

### Which linking iterations to keep?

```{r}

keep_iter_ids_base <- linking_info %>%
  filter(date <= date_method_change
         & keywords == "False" 
         ) 

keep_iter_ids_revise <- linking_info %>%
  filter(date > date_method_change
        & keywords == "True"
        ) %>%
  # keep only the latest iteration here 
  group_by(field) %>%
  filter(iteration_id == max(iteration_id)) %>%
  ungroup()
stopifnot(nrow(keep_iter_ids_revise) == n_distinct(keep_iter_ids_revise$field))

keep_iter_ids <- list(
  base = keep_iter_ids_base,
  revise = keep_iter_ids_revise
)

keep_iter_ids <- map(
  .x = keep_iter_ids,
  .f = ~.x %>% 
    filter(field %in% select_fields) %>%
    pull(iteration_id)
)

linked_ids <- map(
  .x = keep_iter_ids,
  .f = ~linked_ids %>% 
    filter(iteration_id %in% .x)
)




```


```{r}
d_links <- map(
  .x = linked_ids,
  .f = ~.x %>%
    left_join(mag_authors %>%
                select(AuthorId,
                       year_mag = year,
                       firstname_mag = firstname,
                       lastname_mag = lastname,
                       field_mag = fieldofstudy,
                       field0_mag = mag_field0),
              by = "AuthorId") %>%
    left_join(pq_authors %>%
                select(goid,
                       year_pq = year,
                       firstname_pq = firstname,
                       lastname_pq = lastname,
                       field_pq = fieldofstudy,
                       field0_pq = mag_field0),
              by = "goid") %>%
    mutate(year_diff = year_mag - year_pq,
           same_firstname = ifelse(firstname_mag == firstname_pq, 1, 0),
           same_lastname = ifelse(lastname_mag == lastname_pq, 1, 0)) %>%
    left_join(field_names_id %>%
                rename(main_field = NormalizedName),
              by = c("field0_pq" = "FieldOfStudyId")) %>%
    filter(goid != 305107842)  %>% #  this is some author which was linked but should not have been in pq data; unclear why.
    filter(link_score > min_link_score
           & abs(year_diff) <= max_year_diff)
  
  )

d_links$base <- d_links$base %>% filter(year_pq <= 2005) 

```




## Some histograms 
### link score by field 
```{r, echo = FALSE}

map(.x = d_links,
    .f = ~.x %>%  
      mutate(cohort = 10 * floor(year_pq / 10)) %>%
      ggplot(aes(x = link_score)) +
      geom_histogram(aes(y = ..density..),
                    position = position_dodge(),
                    bins = 50) +
      theme(legend.position = "bottom") +
      facet_wrap(~cohort) 
    )

```

### Year between first pub and graduation 

- why are there other fields than maths/biology for the following two figures?
- this is because we sample persons whenever they are in any of the linking fields
  - thus, a graduate can be linked in a biology iteration if her first field is chemistry
  - compare this with the advisor links! 
  - this also means the join above should take care of this, and indicate the multiplicity of the graduates! 


```{r, echo = FALSE}

map(.x = d_links,
    .f = ~.x %>%
      mutate(cohort = 10 * floor(year_pq / 10)) %>%
      ggplot(aes(x = year_diff, fill = main_field, group = main_field)) +
      geom_histogram(aes(y = ..density..), position = position_dodge()) +
      theme(legend.position = "bottom") +
      facet_wrap(~cohort) +
      geom_vline(xintercept = 0, linetype = "dashed", color = "grey30") +
      labs(x = "Year first pub. - Year graduation")
    )

```


## First and last name matches by cohort and field

```{r, echo = FALSE}

map(.x = d_links,
    .f = ~.x %>% 
       mutate(cohort = floor(year_pq / 5) * 5) %>%
      group_by(cohort, main_field) %>%
      summarise(across(all_of(c("same_firstname", "same_lastname")),
                     ~mean(.x)),
                .groups = "drop") %>%
      gather(key = name, value = val, -cohort, -main_field) %>%
      mutate(name = gsub("same_|name", "", name)) %>%
      ggplot(aes(x = cohort, y = val,
                 color = main_field,
                 linetype = name)) +
      geom_line() +
      theme(legend.position = "bottom") +
      labs(y = "Fraction of links with same first/last name") +
      guides(color = "none")
      )


```




## How do fields of ProQuest map into fields in MAG?
```{r, echo = FALSE}
dtemp <- d_links$base %>% # does not make much sense for revise because we use the keywords for linking 
    mutate(grp_year = ifelse(year_pq > 1980, ">1980", "<=1980")) %>%
    group_by(main_field, field_mag, field_pq) %>%
    summarise(nb = n(),
                link_score = mean(link_score),
                .groups = "drop") %>%
    group_by(main_field, field_mag) %>%
    mutate(s = nb / sum(nb)) %>%
    # keep only top 10 fields in mag
    group_by(main_field) %>%
    arrange(desc(nb)) %>%
    mutate(rk = row_number()) %>%
    filter(rk <= 30)

map(.x = select_fields,
    .f = ~dtemp %>%
        filter(main_field == .x) %>%
        ggplot(aes(x = field_mag, y = field_pq)) +
        geom_tile(aes(fill = s)) +
        theme(legend.position = "bottom",
            axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
        labs(title = "Fraction of field ProQuest into field MAG",
            subtitle = paste0("Field: ", .x)) +
        scale_fill_gradient2(low = "red", mid = "yellow", high = "blue",
                midpoint = quantile(dtemp$s, 0.5))
    )

```


## Fraction matched by year and field 
```{r, echo = FALSE}

keep_fields <- c("biology", "computer science", "economics",
                 "chemistry", "psychology", "mathematics")

d_compare <- map(
  .x = d_links,
  .f = ~pq_authors %>%
     left_join(field_names_id %>%
                  rename(main_field = NormalizedName),
              by = c("mag_field0" = "FieldOfStudyId")) %>%
      mutate(link = ifelse(goid %in% .x$goid, "linked", "not linked")) %>%
      group_by(year, main_field, link) %>%
      summarise(nb = n(), .groups = "drop")
) %>%
  bind_rows(.id = "version") %>%
  group_by(version, year, main_field) %>% 
  mutate(s = nb / sum(nb)) %>%
  ungroup() %>% 
  filter(link == "linked") %>%
  filter(main_field %in% keep_fields) 

d_compare %>% 
  ggplot(aes(x = year, y = s, linetype = version)) +
  geom_line() +
  theme(legend.position = "bottom") +
  labs(y = "Fraction matched") +
  facet_wrap(~main_field)

d_compare %>% 
  ggplot(aes(x = year, y = nb, linetype = version)) +
  geom_line() +
  theme(legend.position = "bottom") +
  labs(y = "N matched") +
  facet_wrap(~main_field)
  



``` 


# Checking non-linked entities that should be a link

```{r}

d_chem <- pq_authors %>% 
   left_join(field_names_id %>%
                  rename(main_field = NormalizedName),
              by = c("mag_field0" = "FieldOfStudyId")) %>%
      mutate(link = ifelse(goid %in% d_links$revise$goid, "linked", "not linked")) %>%
  filter(main_field == "chemistry")
  
pq_unis <- tbl(con, "pq_authors") %>%
  left_join(tbl(con, "pq_unis") %>%
              select(university_id, normalizedname),
            by = "university_id") %>%
  select(goid, uni_name = "normalizedname") %>%
  collect()

d_chem <- d_chem %>%
  left_join(pq_unis, by = "goid")

```


```{r}
d_chem %>% 
  filter(year == 1995 & uni_name == "stanford university" & link == "not linked") %>% head(10)

#unique(d_chem$fieldofstudy)
## comparing to candidates:
# harvard:
# weldon in materials science 
# beltrame in chemistry 
# mit:
# lapointe is chemistry
# duff is chemistry 
# stanford:
# shear in chemistry 
# marcus is in biology 
# hansen is in biology 
# tokmakoff is in materials science 

# update, chemistry check 8/11/22
# - tokmakoff still not linked; b/c of year first pub? -- yes, the linking score is 0.66... 
# - nancy fisher hansen (2649181519) is not linked (unclear if she should be linked)
# - hopefully the keywords from topic models would help us here?
# - maybe david h offord (304201950) would also be linked with the keywords?

```

# Chemistry: first affiliation of MAG authors should be the graduating institution. [paper](https://direct.mit.edu/rest/article-abstract/95/2/698/58091/Chinese-Graduate-Students-and-U-S-Scientific?redirectedFrom=fulltext)

```{r}
grads_chemistry <- d_links$revise |>
  filter(field0_mag == 185592680) |>
  group_by(AuthorId) |>
  filter(iteration_id == max(iteration_id)) |>
  ungroup() |>
  mutate(grp = case_when( # some people publish already way before the PhD
    year_mag > year_pq ~ "first pub after PhD",
    year_mag < year_pq - 6 ~ "first pub before PhD",
    TRUE ~ "first pub during PhD"
  )) |>
  select(AuthorId, goid, year_pq, grp)
```

```{r}
head(grads_chemistry)

grads_chemistry |> 
  group_by(grp, year_pq) |> 
  summarise(nb = n()) |>
  ungroup() |>
  group_by(year_pq) |>
  mutate(total = sum(nb)) |>
  ggplot(aes(x = year_pq, y = nb/total)) + 
  geom_line(aes(linetype = grp)) +
  theme(legend.position = "bottom")

```

Gaule/Piacentini had 21154 graduates from 1999 to 2008; we have 

```{r}
grads_chemistry |> 
  filter(year_pq >= 1999 & year_pq <= 2008) |> 
  summarise(n())
```
- they had chemists and chemical engineers; we may miss the engineers in this sample.


```{r}
grads_chemistry |>
  filter(year_pq >= 1990 & year_pq <= 2015) |> 
  group_by(grp) |>
  summarise(nb = n()) |>
  ungroup() |>
  mutate(s = nb / sum(nb))
```



```{r}

query_authors <- unique(grads_chemistry$AuthorId)
query_authors <- paste0(query_authors, collapse = ", ")
q_authors_affil <- paste0(
  "SELECT AuthorId, AffiliationId, Year
  FROM AuthorAffiliation
  INNER JOIN (
    SELECT AuthorId, YearFirstPub
    FROM author_sample
  ) USING(AuthorId)
  WHERE AuthorId IN (", query_authors, ")
  AND Year <= YearFirstPub + 20"
)

authors_affil <- tbl(con, sql(q_authors_affil)) |>
  collect() 

authors_first_affil <- authors_affil |>
  group_by(AuthorId) |>
  filter(Year == min(Year)) |>
  filter(!duplicated(AuthorId)) |>
  ungroup()



```


```{r}
links_to_cng <- tbl(con, "links_to_cng") |>
  collect()
```


### Place of first publication

```{r}
place_first_pub <- grads_chemistry |>
  left_join(pq_authors |>
              select(goid, university_id),
            by = "goid") |>
  left_join(links_to_cng |>
              filter(from_dataset == "pq") |>
              select(from_id, unitid_graduate = unitid),
            by = c("university_id" = "from_id")) |>
  left_join(authors_first_affil |>
              select(AuthorId, AffiliationId),
            by = "AuthorId") |>
  left_join(links_to_cng |>
              filter(from_dataset == "mag") |>
              select(from_id, unitid_author = unitid),
            by = c("AffiliationId" = "from_id"))
```

```{r}
place_first_pub |>
  mutate(same_institution = ifelse(unitid_graduate == unitid_author, 1, 0)) |>
  group_by(year_pq) |>
  summarise(same_institution = mean(same_institution, na.rm = T),
            .groups = "drop") |>
  ggplot(aes(x = year_pq, y = same_institution)) +
  geom_line() +
  geom_point()
```

### If publishing during PhD, does so at least once at the PhD university?

```{r}
publish_during_phd <- authors_affil |>
  left_join(grads_chemistry |>
              select(-grp),
            by = c("AuthorId")) |>
  filter(Year <= year_pq & Year >= year_pq - 6) |>
  left_join(links_to_cng |>
              filter(from_dataset == "mag") |>
              select(from_id, unitid_author = unitid),
            by = c("AffiliationId" = "from_id")) |>
  left_join(pq_authors |>
              select(goid, university_id),
            by = "goid") |>
  left_join(links_to_cng |>
              filter(from_dataset == "pq") |>
              select(from_id, unitid_graduate = unitid),
            by = c("university_id" = "from_id")) |>
  select(AuthorId, Year, year_pq, unitid_author, unitid_graduate, university_id) |>
  mutate(same_institution = ifelse(unitid_author == unitid_graduate, 1, 0),
         same_institution = ifelse(is.na(same_institution), 0, same_institution))

```


Fraction of students not publishing during PhD:
```{r}
1 - n_distinct(publish_during_phd$AuthorId) / n_distinct(grads_chemistry$AuthorId)
```



```{r}
# group by student: at least one pub with the PhD university?
publish_during_phd <- publish_during_phd |>
  group_by(AuthorId) |>
  filter(same_institution == max(same_institution)) |>
  filter(!duplicated(AuthorId))

publish_during_phd |>
  group_by(year_pq) |>
  summarise(same_institution = mean(same_institution, na.rm = T),
            .groups = "drop") |>
  ggplot(aes(x = year_pq, y = same_institution)) +
  geom_line() +
  geom_point()
  

```

```{r}
summary(publish_during_phd)
```



```{r}
head(publish_during_phd |> filter(same_institution == 0))
```

notes
- some may publish after phd with the phd affiliation -- not captured here 
- misses research institutes that are not in Carnegie, ie scripps research institute
- all in all, this is a lower bound on the precision in the sample of people publishing during their PhD
- the lower bound on precision for the sample of chemists can be calculated as follows
  - 19% publish after PhD; assume they are all false positives 
  - of the remaining 81%, 87% publish at their graduating university
  - thus, our precision is at least 0.81 * 0.87 = 0.70
- this calculation is more difficult in fields where graduates publish more often after graduating


```{r, include = FALSE}
DBI::dbDisconnect(con)
```

