---
title: "Performance of linking graduates"
author: "Flavio & Christoph & Mona"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  pdf_document:
    toc: true
    toc_depth: 3
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

set.seed(1234)
```

```{r, echo = FALSE, include = FALSE}
packages <- c("tidyverse", "broom", "dbplyr", "RSQLite", "ggplot2", "stringdist", "knitr", "kableExtra") 

lapply(packages, library, character.only = TRUE)
options(knitr.table.format = "latex")

datapath <- "/mnt/ssd/linked_ids_temp/"
```


```{r}
 # Function to process the data for a specific field

process_data <- function(field) {
  
  # Read the data for the specified field
  
  if (field %in% c("history")) {
  links_graduates_mona <- read.csv(paste0(datapath,"links_graduates_", field, "_mona_degree0_19852015.csv"),  colClasses = c("integer64", "integer64", "numeric")) %>%
    filter(link_score>0.7) %>%
    rename(authorid_mona = AuthorId) %>%
    rename(linkscore_mona=link_score)
  } else {
    links_graduates_mona <- read.csv(paste0(datapath,"/links_graduates_", field, "_mona_degree0_19852015.csv"),  colClasses = c("integer64", "integer64", "numeric")) %>%
    filter(link_score>0.7) %>%
    rename(authorid_mona = grantid_authorposition) %>%
    rename(goid = AuthorId) %>%
    rename(linkscore_mona=link_score)
}

  if (field %in% c("biology", "computer science","economics", "engineering", "environmental science", "geology", "political science", "psychology", "physics")) {
  links_graduates_christoph <- read.csv(paste0(datapath,"links_graduates_", field, "_christoph_fielddegree0.csv"),  colClasses = c("integer64", "integer64", "numeric")) %>%
    filter(link_score>0.7) %>%
    rename(authorid_christoph = AuthorId) %>%
    rename(linkscore_christoph=link_score) 
  } else {
  links_graduates_christoph <- read.csv(paste0(datapath,"links_graduates_", field, "_christoph_degree0_19852015.csv"),  colClasses = c("integer64", "integer64", "numeric")) %>%
    filter(link_score>0.7) %>%
    rename(authorid_christoph = AuthorId) %>%
    rename(linkscore_christoph=link_score)     
  }    
      

links_graduates_mona <- collect(links_graduates_mona)
links_graduates_christoph <- collect(links_graduates_christoph)

# Performs the full join: bothlink=1 if same authorID assigned in both, 0 if different authorID assigned
# Then calculates the share of links found by Christoph also found by Mona (number links found by both divided by number of links found by Christoph) (share_bothlink)

links_graduates <- links_graduates_mona %>%
  full_join(links_graduates_christoph, by = c("goid")) %>%
  mutate(
    field = field,
    monalink = ifelse(!is.na(authorid_mona), 1, 0),
    chrislink = ifelse(!is.na(authorid_christoph), 1, 0),
    bothlink = ifelse(is.na(authorid_christoph) | is.na(authorid_mona),
                      NA,
                      ifelse(authorid_christoph == authorid_mona, 1, 0)),
     share_bothlink = sum(bothlink == 1 & chrislink == 1, na.rm = TRUE) / sum(chrislink == 1, na.rm = TRUE)
  )

# Look closer at link differences: 
# share of ProQuest goids assigned to same AuthorId (share_sameauthor), distinct AuthorId (share_diffauthor), or missing (share_missing) in one of the two linkings


links_graduates <- links_graduates %>%
 mutate(
    share_sameauthor = sum(bothlink == 1, na.rm = TRUE) / n_distinct(goid),
    share_diffauthor = sum(bothlink == 0 & !is.na(bothlink), na.rm = TRUE) / n_distinct(goid),
    share_missing = sum(is.na(bothlink)) / n_distinct(goid),
    share_missing_mona = sum(is.na(bothlink) & monalink == 0) / n_distinct(goid),
    share_missing_chris = sum(is.na(bothlink) & chrislink == 0) / n_distinct(goid),
    share_chris_samemona = sum(chrislink & bothlink==1, na.rm=TRUE) / sum(chrislink, na.rm=TRUE)
 ) 

# Create table with the shares by field
# Problem: not shown in pdf, ugly table here

shares_table  <- links_graduates %>%
  select(field, share_bothlink, share_sameauthor, share_diffauthor, share_missing, share_chris_samemona) %>%
  group_by(field) %>%
  summarize(
    share_bothlink = mean(share_bothlink, na.rm = TRUE),
    share_sameauthor = mean(share_sameauthor, na.rm = TRUE),
    share_diffauthor = mean(share_diffauthor, na.rm = TRUE),
    share_missing = mean(share_missing, na.rm = TRUE),
    share_chris_samemona = mean(share_chris_samemona, na.rm = TRUE)
  )

# Select the shares for the bar chart: total number of goids as base

shares_data <- links_graduates %>%
  summarise(
    share_sameauthor = mean(share_sameauthor, na.rm = TRUE),
    share_diffauthor = mean(share_diffauthor, na.rm = TRUE),
    share_missing = mean(share_missing, na.rm = TRUE),
    share_chris_samemona = mean(share_chris_samemona, na.rm = TRUE)
  ) %>%
  gather(variable, value)

# Create the bar chart
bar_chart <- ggplot(shares_data, aes(x = variable, y = value, fill = variable)) +
  geom_bar(stat = "identity", width = 0.7) +
  theme_minimal() +
  labs(
    x = NULL,
    y = "Fraction",
    title = paste("Fraction of ProQuest goids based on assignment of AuthorID  for",field),
    fill= NULL
  ) +
  scale_x_discrete(labels = c("Mona same author ID|Chris linked","different author ID", " author ID missing", "same author ID"))


# Print the bar chart
print(bar_chart)

# Print the summary table 

shares_table %>%
  kable(format = "html", 
        align = c("l", "c", "c", "c", "c", "c"), 
        digits = 2, 
        caption = "Share Statistics by Field",
        booktabs = TRUE)
} 
```

```{r, include=TRUE}
# Fields to process
# missing fields: ""art, "chemistry", "geography", "history", "mathematics","medicine", "sociology"


fields_to_process <- c("biology", "business", "computer science", "economics", "engineering", "environmental science", "geology", "history", "materials science", "philosophy", "physics", "political science", "psychology")

# Loop through the fields

for (field in fields_to_process) {
  table <- process_data(field)
  print(table)
  cat("\n\n")
}  
```
------------
- many missings between Christoph's and Mona's links
- share of Mona's links compared to Christoph's links low (share_bothlink) but mostly due to missings and different author assignment 
- in most fields, goids linked to the same authors, only few that were linked to different ones
- exception in physics, most authors linked differently, why? (no obvious mistakes when renaming variables and joining the datasets)


## Now do the same just for physics but for christoph, mona and flavio
```{r}

process_data <- function(field) {
  # Reads data for specified field
  
  # Read the data for Mona
  links_graduates_mona <- read.csv(paste0(datapath,"links_graduates_", field, "_mona_degree0_19852015.csv"),  colClasses = c("integer64", "integer64", "numeric")) %>%
    filter(link_score>0.7) %>%
    rename(authorid_mona = grantid_authorposition) %>%
    rename(goid = AuthorId) %>%
    rename(linkscore_mona=link_score)   
  # Read the data for Flavio
  links_graduates_flavio <- read.csv(paste0(datapath,"links_graduates_", field, "_flavio_degree0_19852015.csv"),  colClasses = c("integer64", "integer64", "numeric")) %>%
    filter(link_score>0.7) %>%
    rename(authorid_flavio = AuthorId) %>%
    rename(linkscore_flavio=link_score)

  # Read the data for Christoph
  links_graduates_christoph <- read.csv(paste0(datapath,"links_graduates_", field, "_christoph_degree0_19852015.csv"),  colClasses = c("integer64", "integer64", "numeric")) %>%
    filter(link_score>0.7) %>%
    rename(authorid_christoph = AuthorId) %>%
    rename(linkscore_christoph=link_score)     

  links_graduates_mona <- collect(links_graduates_mona)
  links_graduates_flavio <- collect(links_graduates_flavio)
  links_graduates_christoph <- collect(links_graduates_christoph)

  # Join the data
  links_graduates <- links_graduates_mona %>%
    full_join(links_graduates_flavio, by = c("goid")) %>%
    full_join(links_graduates_christoph, by = c("goid")) %>%
    mutate(
      field = field,
      
      mona_same_as_chris = ifelse(authorid_mona == authorid_christoph, 1, 0),
      flavio_same_as_chris = ifelse(authorid_flavio == authorid_christoph, 1, 0),
      
      mona_diff_from_chris = ifelse(authorid_mona != authorid_christoph & !is.na(authorid_mona) & !is.na(authorid_christoph), 1, 0),
      flavio_diff_from_chris = ifelse(authorid_flavio != authorid_christoph & !is.na(authorid_flavio) & !is.na(authorid_christoph), 1, 0)
      
    ) %>%
    replace_na(list(mona_same_as_chris = 0, flavio_same_as_chris = 0, mona_diff_from_chris = 0, flavio_diff_from_chris = 0)) %>%
    mutate(
      # Calculate shares
      share_mona_same_as_chris = mean(mona_same_as_chris, na.rm = TRUE),
      share_flavio_same_as_chris = mean(flavio_same_as_chris, na.rm = TRUE),
      share_mona_diff_from_chris = mean(mona_diff_from_chris, na.rm = TRUE),
      share_flavio_diff_from_chris = mean(flavio_diff_from_chris, na.rm = TRUE)
    )
  
  # Create table with the shares by field
  shares_table  <- links_graduates %>%
    select(field, share_mona_same_as_chris, share_flavio_same_as_chris, share_mona_diff_from_chris, share_flavio_diff_from_chris) %>%
    group_by(field) %>%
    summarize(
      share_mona_same_as_chris = mean(share_mona_same_as_chris, na.rm = TRUE),
      share_flavio_same_as_chris = mean(share_flavio_same_as_chris, na.rm = TRUE),
      share_mona_diff_from_chris = mean(share_mona_diff_from_chris, na.rm = TRUE),
      share_flavio_diff_from_chris = mean(share_flavio_diff_from_chris, na.rm = TRUE)
    )
  
  # Return the table
  shares_table %>%
    kable(format = "latex", 
          align = c("l", "c", "c", "c", "c"), 
          digits = 2, 
          caption = "Share Statistics by Field",
          booktabs = TRUE)
}
```


```{r}
# Specify the field to process
field_to_process <- "physics"

# Process the data
table <- process_data(field_to_process)

# Print the table
print(table)
```