---
title: "Performance of linking graduates to researchers"
author: "Flavio & Christoph"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  pdf_document:
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
set.seed(1234)
```

```{r, echo = FALSE, include = FALSE}
packages <- c("tidyverse", "broom", "dbplyr", "RSQLite", "ggplot2")

lapply(packages, library, character.only = TRUE)

datapath <- "/mnt/ssd/"
db_file  <- paste0(datapath, "AcademicGraph/AcademicGraph.sqlite")
select_fields <- c("physics", "biology", "chemistry", "sociology",
                    "economics", "political science", "psychology", 
                    "mathematics", "geography", "geology", "engineering",
                    "computer science", "environmental science") # fields currently matched 

# ## db connection
con <- DBI::dbConnect(RSQLite::SQLite(), db_file)
cat("The database connection is: \n")
src_dbi(con)
```

## Overview

### To do
- Add validation: compare co-authors/advisors and affiliations of ids in MAG and PQ
  - but what are we going to compare? not a matching link in co-author/advisor may be either because the link is wrong or because the person did not co-author with the advisor. So we will need to be cautious here in the interpretation.
  - maybe it is better to use some measure of text similarity between the dissertation title and the papers? this does not depend on whether the person co-authored with advisor or not 
- Do some robustness checks based on the Abramitzky et al JEL paper
- plot share linked by gender? 


### SQL example for sourcing number of authors with same name 

```sql 
select * 
from author_sample
inner join (
    select authorid, normalizedname, papercount, citationcount
    from authors 
    where normalizedname = "lawrence b slobodkin"
) using (authorid)
inner join (
    select authorid, fieldofstudyid
    from author_fields 
    where fieldclass = "first"
) using (authorid)
```

```{r, include = FALSE}
field_names_id <- tbl(con, sql(paste0(
    "SELECT FieldOfStudyId, NormalizedName
    FROM FieldsOfStudy
    WHERE Level = 0 
        AND NormalizedName IN (", 
        paste0(paste0("'", select_fields, "'"), collapse = ", "),
        ")"
)))
field_names_id <- collect(field_names_id)

query_proquest <- paste0(
 "SELECT goid
            , year
            , firstname 
            , lastname
            , CASE TRIM(SUBSTR(middle_lastname, 1, l_fullname-l_firstname-l_lastname - 1)) 
                WHEN 
                    '' THEN NULL 
                    ELSE TRIM(SUBSTR(middle_lastname, 1, l_fullname-l_firstname-l_lastname - 1)) 
                END AS middlename
            , fieldofstudy
            , mag_field0
    FROM (
        SELECT goid
            , degree_year AS year 
            , fullname 
            , SUBSTR(TRIM(fullname),1,instr(trim(fullname)||' ',' ')-1) AS firstname
            , REPLACE(fullname, RTRIM(fullname, REPLACE(fullname, ' ', '')), '') AS lastname 
            , TRIM(SUBSTR(fullname, length(SUBSTR(TRIM(fullname),1,instr(trim(fullname)||' ',' ')-1)) + 1)) AS middle_lastname 
            , length(fullname) AS l_fullname 
            , length(SUBSTR(TRIM(fullname),1,instr(trim(fullname)||' ',' ')-1) ) AS l_firstname
            , length(REPLACE(fullname, RTRIM(fullname, REPLACE(fullname, ' ', '')), '')) AS l_lastname
            , fieldname AS fieldofstudy
            , mag_field0
            , university_id
        FROM pq_authors 
        INNER JOIN (
            SELECT goid, fieldname, mag_field0
            FROM pq_fields_mag
            WHERE mag_field0 IN (",
            paste0(field_names_id$FieldOfStudyId, collapse = ', '),
            ") 
        ) USING (goid)
        INNER JOIN (
            SELECT university_id
            FROM pq_unis
            WHERE location like '%United States%'
        ) USING(university_id)
)
WHERE year >= 1985 and year <= 2005 AND length(firstname) > 1
")

query_mag <- paste0(
 "SELECT AuthorId
        , year
        , firstname
        , lastname
        , CASE TRIM(SUBSTR(middle_lastname, 1, l_fullname-l_firstname-l_lastname - 1)) 
            WHEN 
                '' THEN NULL 
                ELSE TRIM(SUBSTR(middle_lastname, 1, l_fullname-l_firstname-l_lastname - 1)) 
            END as middlename 
        , fieldofstudy
        , mag_field0 
    FROM (
        SELECT a.AuthorId
            , a.YearFirstPub AS year
            , a.FirstName AS firstname
            , REPLACE(b.NormalizedName, RTRIM(b.NormalizedName, REPLACE(b.NormalizedName, ' ', '')), '') AS lastname 
            , TRIM(SUBSTR(b.NormalizedName, length(a.FirstName) + 1)) AS middle_lastname 
            , length(b.NormalizedName) as l_fullname 
            , length(a.FirstName) as l_firstname
            , length(REPLACE(b.NormalizedName, RTRIM(b.NormalizedName, REPLACE(b.NormalizedName, ' ', '')), '')) as l_lastname
            , e.NormalizedName AS fieldofstudy
            , e.ParentFieldOfStudyId as mag_field0
        FROM author_sample AS A 
        INNER JOIN (
            SELECT AuthorId, NormalizedName
            FROM Authors
        ) AS b USING(AuthorId)
        INNER JOIN (
            SELECT AuthorId, NormalizedName, ParentFieldOfStudyId
            FROM author_fields c
            INNER JOIN (
                SELECT FieldOfStudyId, NormalizedName
                FROM FieldsOfStudy
            ) AS d USING(FieldOfStudyId)
            INNER JOIN (
                SELECT ParentFieldOfStudyId
                    , ChildFieldOfStudyId
                    , ParentFieldOfStudyId 
                FROM crosswalk_fields
                WHERE ParentLevel = 0
                    AND ParentFieldOfStudyId IN (",
                         paste0(field_names_id$FieldOfStudyId, collapse = ", "),
                    ")
            ) AS e ON (e.ChildFieldOfStudyId = c.FieldOfStudyId)
            WHERE FieldClass = 'first'
        ) AS e USING(AuthorId)
    )
WHERE year >= 1980 and year <= 2010 AND length(firstname) > 1
")

```

```{r, include = FALSE}
linked_ids <- tbl(con, "linked_ids") 
linking_info <- tbl(con, "linking_info") %>%
    filter(mergemode == "1:1" & keywords == "False")
pq_authors <- tbl(con, sql(query_proquest))
mag_authors <- tbl(con, sql(query_mag))

# pq_fields_mag <- tbl(con, "pq_fields_mag")
# mag_fields <- tbl(con, "FieldsOfStudy") %>%
#     filter(Level <= 1) %>%
#     select(FieldOfStudyId, NormalizedName)


# authors <- tbl(con, sql(q)) %>%
#     left_join(mag_fields %>%
#                 rename(name_main_field = NormalizedName),
#                 by = c("main_field" = "FieldOfStudyId")) %>%
#     left_join(mag_fields %>%
#                 rename(name_first_field = NormalizedName),
#                 by = c("first_field" = "FieldOfStudyId")) %>%
#     select(-first_field, -main_field) %>%
#     filter(name_main_field %in% select_fields)

```

```{r, include = FALSE}
mag_authors <- collect(mag_authors)
linked_ids <- collect(linked_ids)
linking_info <- collect(linking_info)
pq_authors <- collect(pq_authors)
```

### Which linking iterations to keep?

```{r}
keep_iteration_ids <- linking_info %>%
    filter(field %in% select_fields) %>%
    pull(iteration_id)
linked_ids <- linked_ids %>%
    filter(iteration_id %in% keep_iteration_ids)
```


```{r, include = FALSE}
d_links <- linked_ids %>%
    left_join(mag_authors %>%
                select(AuthorId,
                        year_mag = year,
                        firstname_mag = firstname,
                        lastname_mag = lastname,
                        field_mag = fieldofstudy,
                        field0_mag = mag_field0),
                by = "AuthorId") %>%
    left_join(pq_authors %>%
                select(goid,
                        year_pq = year,
                        firstname_pq = firstname,
                        lastname_pq = lastname,
                        field_pq = fieldofstudy,
                        field0_pq = mag_field0),
                by = "goid")


d_links <- d_links %>%
    mutate(year_diff = year_mag - year_pq,
            same_firstname = ifelse(firstname_mag == firstname_pq, 1, 0),
            same_lastname = ifelse(lastname_mag == lastname_pq, 1, 0)) %>%
    left_join(field_names_id %>% 
                rename(main_field = NormalizedName),
              by = c("field0_pq" = "FieldOfStudyId"))

d_links <- d_links %>%
    filter(goid != 305107842) # this is some author which was linked but should not have been in pq data; unclear why.


d_links <- d_links %>%
    filter(link_score >= 0.5) %>%
    filter(year_diff >= -5 & year_diff <= 5)
```



## Some histograms 
### link score by field 
```{r, echo = FALSE}
d_links %>%
    mutate(cohort = 10 * floor(year_pq / 10)) %>%
    # ggplot(aes(x = link_score, fill = main_field, group = main_field)) +
    ggplot(aes(x = link_score)) +
    geom_histogram(aes(y = ..density..),
                    position = position_dodge()) +
    theme(legend.position = "bottom") +
    facet_wrap(~cohort) 
```

### Year between first pub and graduation 
```{r, echo = FALSE}
d_links %>%
    mutate(cohort = 10 * floor(year_pq / 10)) %>%
    ggplot(aes(x = year_diff, fill = main_field, group = main_field)) +
    # ggplot(aes(x = year_diff)) +
    geom_histogram(aes(y = ..density..), position = position_dodge()) +
    # geom_density(alpha = 0.3) +
    theme(legend.position = "bottom") +
    facet_wrap(~cohort) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "grey30") +
    labs(x = "Year first pub. - Year graduation")
```


## First and last name matches by cohort and field
```{r, echo = FALSE}
d_links %>%
    mutate(cohort = floor(year_pq / 5) * 5) %>%
    group_by(cohort, main_field) %>%
    summarise(across(all_of(c("same_firstname", "same_lastname")),
                     ~mean(.x))) %>%
    gather(key = name, value = val, -cohort, -main_field) %>%
    mutate(name = gsub("same_|name", "", name)) %>%
    ggplot(aes(x = cohort, y = val,
                color = main_field,
                linetype = name)) +
    geom_line() +
    theme(legend.position = "bottom") +
    labs(y = "Fraction of links with same first/last name") +
    guides(color = "none")
```




## How do fields of ProQuest map into fields in MAG?
```{r, echo = FALSE}
dtemp <- d_links %>%
    mutate(grp_year = ifelse(year_pq > 1980, ">1980", "<=1980")) %>%
    group_by(main_field, field_mag, field_pq) %>%
    summarise(nb = n(),
                link_score = mean(link_score),
                .groups = "drop") %>%
    group_by(main_field, field_mag) %>%
    mutate(s = nb / sum(nb)) %>%
    # keep only top 10 fields in mag
    group_by(main_field) %>%
    arrange(desc(nb)) %>%
    mutate(rk = row_number()) %>%
    filter(rk <= 30)

map(.x = select_fields,
    .f = ~dtemp %>%
        filter(main_field == .x) %>%
        ggplot(aes(x = field_mag, y = field_pq)) +
        geom_tile(aes(fill = s)) +
        theme(legend.position = "bottom",
            axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
        labs(title = "Fraction of field ProQuest into field MAG",
            subtitle = paste0("Field: ", .x)) +
        scale_fill_gradient2(low = "red", mid = "yellow", high = "blue",
                midpoint = quantile(dtemp$s, 0.5))
    )

```


## Fraction matched by year and field 
```{r, echo = FALSE}
d_matched <- pq_authors %>%
    left_join(field_names_id %>%
                rename(main_field = NormalizedName),
              by = c("mag_field0" = "FieldOfStudyId")) %>%
    mutate(link = ifelse(goid %in% linked_ids$goid, "linked", "not linked")) %>%
    group_by(year, main_field, link) %>%
    summarise(nb = n(), .groups = "drop") %>%
    group_by(year, main_field) %>%
    mutate(s = nb / sum(nb)) %>%
    ungroup() %>%
    filter(link == "linked")

d_matched %>%
    ggplot(aes(x = year, y = s, linetype = main_field)) +
    geom_line() +
    theme(legend.position = "bottom") +
    labs(y = "Fraction matched")
``` 


```{r, include = FALSE}
DBI::dbDisconnect(con)
```


## Old comments; perhaps some of the are helpful when writing the paper 

- Fraction matched 
    - what explains the difference between biology and history? 
        - need to compare to transition rates to academia also!
        - could we somehow find a measure of "potential" links? i.e. to assess the option that we cannot match more?
    - brainstorming: other differences? 
        - distribution of names
        - distribution of duplicates
        - book field vs paper field
- The linking seems to work ok (probably we should increase precision a bit to reduce false positives)
- Duplicates in MAG are a problem because they may not find the right match 
    - Need more data 
        - how common / how likely are duplicates in MAG?
        - are they more common in earlier years? 
        - *Idea*: count the number of authors per name and major field (maybe as fraction of all authors to correct for size and thus mechanically more distinct authors with the same name) - this could give a rough indication of duplicates 
            - see sql code example below
    - deduplication with authors based on self-citation may not work if the  random papers have no citations, 
    e.g. [this](https://academic.microsoft.com/author/2582794880/publication/search?q=Lawrence%20B.%20Slobodkin&qe=Composite(AA.AuId%253D2582794880)&f=&orderBy=0&paperId=2070392587) 
    is a duplicate of an ecologist with the same name. The papers there have not references (and are not co-authored I think),
    making it hard to deduplicate with the approach of that information science paper that uses co-authors and self-references.
    - As a result of this, we may adjust the data in two ways 
        1. drop authors that only publish papers without any references (could this be problematic)
        2. do the deduplication of authors following the other paper 
    - #1 is perhaps less relevant if the MAG does not assign the correct field to the entity (as happened in the case above)
    - Deduplication is even more important because duplicates can create *negative* sample selection 
        - famous authors publish more, and are more likely to have a duplicate. They may also publish more "opinion" pieces / pieces for general public which MAG may not rightly assign (for instance because of missing references)
        - if we then just drop those where the distance is large, we drop the best graduates
        - a quadratic in year difference may help selecting the entity closer to the actual graduation date, but there is no guarantee we'll pick the right entity 
    - What are potential problems of the deduplication, and how long should it take?
        - Should we use dedupe by field, or the approach of that other paper? 
- What is going on with the average difference between year first pub and year graduation across cohorts? Is it a problem at all?
- Implications for the algorithm 
     - check the F-score in dedupe -- where can we set it?
     - change other parameters?
     - should we use a quadratic in the difference between year first pub and year graduation? would this help? does dedupe have this already?
- Implications for paper 
    - Manually check some links for false positives 
    - Manually check some authors in MAG/proquest for false negatives?

#### Other questions

- what is going on with year_diff over cohorts? 
    - are there more duplicates for older authors --> makes it harder to find the "right" match?
    - what does the algo do there? should we change it? 
    - sampling
        - are early years underrepresented?
        - can we stratify the sampling somehow?
    - modeling
        - should we interact the variables with decade FEs? how can we do this?
    - idea: use the same labeled training set and try out different specs
        - they should all be saved with a special name in the db 
    - missing publications in MAG in early years? 
- are short names more common in proquest early on? there seem to be many authors with only 2 letters: "br", "je", ...

